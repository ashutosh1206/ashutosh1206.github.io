<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Crypto writeups [Part-2] - InCTFi 2018 | Ashutosh Ahelleya</title><meta name=keywords content="Elliptic-Curves,RSA"><meta name=description content="This blog post covers intended solutions of two crypto challenges from InCTF-2018: Request-Auth and EC-Auth.
Request-Auth Challenge Description
This was a medium level crypto challenge that I created for InCTF International-2018. In the challenge you are given multiple files: iv.txt, key.enc, publickey.pem, ServerSide.py, session.enc and also have a service running these files.
Contents of ServerSide.py:
#!/usr/bin/env python2.7 from Crypto.Cipher import AES from Crypto.PublicKey import RSA from Crypto.Util.number import * from os import urandom import sys BLOCKSIZE = 16 class Unbuffered(object): def __init__(self, stream): self."><meta name=author content="Ashutosh Ahelleya"><link rel=canonical href=https://ashutosh1206.github.io/ctf/inctfi18-crypto-part2/><link crossorigin=anonymous href=/assets/css/stylesheet.bccfefac377bc340f06c260aed1bddf49a4354816d7c570d6aac75a997986c95.css integrity="sha256-vM/vrDd7w0DwbCYK7Rvd9JpDVIFtfFcNaqx1qZeYbJU=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://ashutosh1206.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ashutosh1206.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ashutosh1206.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://ashutosh1206.github.io/apple-touch-icon.png><link rel=mask-icon href=https://ashutosh1206.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css integrity=sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0 crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js integrity=sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4 crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload=renderMathInElement(document.body)></script><meta property="og:title" content="Crypto writeups [Part-2] - InCTFi 2018"><meta property="og:description" content="This blog post covers intended solutions of two crypto challenges from InCTF-2018: Request-Auth and EC-Auth.
Request-Auth Challenge Description
This was a medium level crypto challenge that I created for InCTF International-2018. In the challenge you are given multiple files: iv.txt, key.enc, publickey.pem, ServerSide.py, session.enc and also have a service running these files.
Contents of ServerSide.py:
#!/usr/bin/env python2.7 from Crypto.Cipher import AES from Crypto.PublicKey import RSA from Crypto.Util.number import * from os import urandom import sys BLOCKSIZE = 16 class Unbuffered(object): def __init__(self, stream): self."><meta property="og:type" content="article"><meta property="og:url" content="https://ashutosh1206.github.io/ctf/inctfi18-crypto-part2/"><meta property="article:section" content="ctf"><meta property="article:published_time" content="2018-10-14T00:00:00+00:00"><meta property="article:modified_time" content="2018-10-14T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Crypto writeups [Part-2] - InCTFi 2018"><meta name=twitter:description content="This blog post covers intended solutions of two crypto challenges from InCTF-2018: Request-Auth and EC-Auth.
Request-Auth Challenge Description
This was a medium level crypto challenge that I created for InCTF International-2018. In the challenge you are given multiple files: iv.txt, key.enc, publickey.pem, ServerSide.py, session.enc and also have a service running these files.
Contents of ServerSide.py:
#!/usr/bin/env python2.7 from Crypto.Cipher import AES from Crypto.PublicKey import RSA from Crypto.Util.number import * from os import urandom import sys BLOCKSIZE = 16 class Unbuffered(object): def __init__(self, stream): self."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Ctfs","item":"https://ashutosh1206.github.io/ctf/"},{"@type":"ListItem","position":2,"name":"Crypto writeups [Part-2] - InCTFi 2018","item":"https://ashutosh1206.github.io/ctf/inctfi18-crypto-part2/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Crypto writeups [Part-2] - InCTFi 2018","name":"Crypto writeups [Part-2] - InCTFi 2018","description":"This blog post covers intended solutions of two crypto challenges from InCTF-2018: Request-Auth and EC-Auth.\nRequest-Auth Challenge Description\nThis was a medium level crypto challenge that I created for InCTF International-2018. In the challenge you are given multiple files: iv.txt, key.enc, publickey.pem, ServerSide.py, session.enc and also have a service running these files.\nContents of ServerSide.py:\n#!/usr/bin/env python2.7 from Crypto.Cipher import AES from Crypto.PublicKey import RSA from Crypto.Util.number import * from os import urandom import sys BLOCKSIZE = 16 class Unbuffered(object): def __init__(self, stream): self.","keywords":["Elliptic-Curves","RSA"],"articleBody":"This blog post covers intended solutions of two crypto challenges from InCTF-2018: Request-Auth and EC-Auth.\nRequest-Auth Challenge Description\nThis was a medium level crypto challenge that I created for InCTF International-2018. In the challenge you are given multiple files: iv.txt, key.enc, publickey.pem, ServerSide.py, session.enc and also have a service running these files.\nContents of ServerSide.py:\n#!/usr/bin/env python2.7 from Crypto.Cipher import AES from Crypto.PublicKey import RSA from Crypto.Util.number import * from os import urandom import sys BLOCKSIZE = 16 class Unbuffered(object): def __init__(self, stream): self.stream = stream def write(self, data): self.stream.write(data) self.stream.flush() def writelines(self, datas): self.stream.writelines(datas) self.stream.flush() def __getattr__(self, attr): return getattr(self.stream, attr) sys.stdout = Unbuffered(sys.stdout) class colors: reset='\\033[0m' red='\\033[31m' green='\\033[32m' orange='\\033[33m' blue='\\033[34m' def unpad(s): s = s[:-ord(s[len(s) - 1])] return s def check_valid_request(s): try: s = s.split(\":\") except: return False if len(s) != 3: return False if s[0] != \"bi0s\": return False if s[1][:7] != \"userid=\": return False if s[2][:5] != \"user=\": return False return True class ServerSide: def __init__(self, key, iv): self.key = key[-16:] self.iv = iv[-16:] def process_request(self, req_enc): try: obj2 = AES.new(self.key, AES.MODE_CBC, self.iv) request = obj2.decrypt(req_enc) return check_valid_request(request) except: return False def get_AES_key(): try: key_enc = raw_input(\"Enter encrypted key value in hex: \") key_enc = int(key_enc, 16) except: print colors.red + \"Enter valid input!\" + colors.reset sys.exit() priv_key = RSA.importKey(open(\"privatekey.pem\").read()) n, d = priv_key.n, priv_key.d key_AES = pow(key_enc, d, n) key_AES = long_to_bytes(key_AES) return key_AES string1 = colors.blue + \"\"\" $$\\ $$\\ $$$$$$\\\\ $$ | \\__|$$$ __$$\\\\ $$$$$$$\\ $$\\ $$$$\\ $$ | $$$$$$$\\\\ $$ __$$\\ $$ |$$\\$$\\$$ |$$ _____| $$ | $$ |$$ |$$ \\$$$$ |\\$$$$$$\\\\ $$ | $$ |$$ |$$ |\\$$$ | \\____$$\\\\ $$$$$$$ |$$ |\\$$$$$$ /$$$$$$$ | \\_______/ \\__| \\______/ \\_______/ \"\"\" + colors.reset if __name__ == '__main__': print colors.orange + \"Welcome to bi0s Request Validation Service\" + colors.reset print string1 key = get_AES_key() iv = open(\"iv.txt\").read() obj1 = ServerSide(key, iv) try: ct = raw_input(\"\\nEnter value of encrypted session request in hex: \") ct = ct.decode(\"hex\") except TypeError: print colors.red + \"Enter a valid hex string!\" + colors.reset sys.exit() if obj1.process_request(ct) == True: print colors.green + \"\\nValid request!\" + colors.reset else: print colors.red + \"\\nInvalid request!\" + colors.reset Okay, so the service is basically implementing a hybrid cipher- a combination of RSA and AES to authenticate session requests coming from a user and is internally using a public and a private key in this process.\nClientSide:\nFor every new session, client generates a new valid request The client encrypts the request req in AES-CBC mode using a 16-byte key k and 16-byte Initialisation Vector IV: \\(session\\_enc=E_{AES_{k, IV}}(req)\\) Client then encrypts the 16-byte AES key k using public-key of the server: \\(key\\_enc = k^e\\mod n\\) In the final step, user gives the encrypted session session_enc and encrypted session-key key_enc as an input to the server ServerSide:\nServer receives session_enc and key_enc from the Client. Decrypts key_enc using it‚Äôs private key: \\(k=key\\_enc^d\\mod n\\) Takes 16 least significant bytes of the resultant value of k as the key Decrypts session_enc using value of key obtained from step-3: \\(req=D_{AES_{k, IV}}(session\\_enc)\\) Checks the validity of resultant request using check_valid_request() function. Returns True if the request is valid, False if it isn‚Äôt. Had I been a participant trying to solve this challenge, I would have looked at check_valid_request(). Why? Because mostly in such functions, either there is an intentional vulnerability or you can find some unintended weakness that you can exploit. Let‚Äôs move to that part:\ndef check_valid_request(s): try: s = s.split(\":\") except: return False if len(s) != 3: return False if s[0] != \"bi0s\": return False if s[1][:7] != \"userid=\": return False if s[2][:5] != \"user=\": return False return True Doesn‚Äôt look like ^^ can be exploited. Dead end.\nWe know that the server only tells us if the request is valid or not, we won‚Äôt get a flag from the server directly in any case.\nEither we find the server‚Äôs private key or we find the AES key using which ‚Äãsession.enc is encrypted. We are not able to factorise N, nor are we able to find any weakness in the public key, hence the only remaining option is to find the AES key.\nHow do we find it?\nThe Vulnerability Remember how the server inputs encrypted key and evaluates the key to be used for encryption? Check out the first three steps happening on ServerSide:\nReceives session_enc and key_enc from the client. Decrypts key_enc using it‚Äôs private key: \\(k=key\\_enc^d\\mod n\\) Takes 16 least significant bytes of the resultant value of k as the key Do you see the weakness there? Step-3! ‚ÄúTakes 16 least significant bytes from resultant value of k obtained after decryption‚Äú. Notice that we are in control of the encrypted AES key and hence we can do a chosen ciphertext attack. We have found the vulnerability, next question- how do we exploit it?\nThe Exploit We know that: \\(key\\_enc = k^e\\mod n\\)\nIf we multiply key_enc by \\(2^{me}\\mod n\\), we will have: $$key\\_enc * 2^{me} \\mod n = k^e2^{me}\\mod n$$ $$k^e2^{me}\\mod n = (2^mk)^e\\mod n$$\nSo, just by knowing the ciphertext of k, we can generate values of ciphertext of 2k, 4k, 8k, ‚Ä¶ and so on. We also know that no matter how big the ciphertext is, the server will just take 16 least significant bytes of k after decryption.\nWe will denote \\(key\\_enc_m\\equiv key\\_enc*(2^m\\mod n)\\mod n\\) and \\(k_m\\equiv k*2^m\\mod n\\)\nConsider key_enc127 which is encryption of k127 where every bit but the most significant bit is zero. After sending key_enc127 to the server, upon decryption, only 16 least significant bytes are selected as the key for decrypting the session. This implies that k127‚Äòs most significant bit is k‚Äôs least significant bit. We assume that k127‚Äòs most significant bit is zero, encrypt the session with key that has least significant bit as 0 (Remaining all the bits are anyway zero) and send it to the server.\nIf the server responds with a ‚ÄúValid Response‚Äù message, then the least significant bit of the AES key is 0, otherwise it is 1. Next, we send key_enc126 which is the encryption of k126, encrypt a valid session with key where 0-125th bits from left are zero, 126th bit is zero and 127th bit is the least significant bit of ‚Äãk we got from previous iteration. Again, if the server responds with a ‚ÄúValid Response‚Äù message, then the second least significant bit of AES key is 0, otherwise it is 1.\nWe iterate this for key_enc125, key_enc124, ‚Ä¶, key_enc0, until all the bits of k are obtained. I have implemented this step as a small python snippet:\nfor i in range(127, -1, -1): r = process(\"./run.sh\") key_payload = (key_enc*pow(2, i*publickey.e, publickey.n)) % publickey.n key_dec = hex(int(\"0\" + global_dec_key[::-1] + \"0\"*i, 2))[2:].replace(\"L\",\"\").zfill(32).decode(\"hex\") enc_session_payload = encrypt_request(\"bi0s:userid=test:user=test2\", key_dec, iv) # Sending the payload to the service send_enc_key(key_payload) send_enc_session(enc_session_payload) # Checking if the request is valid if check_enc_req_validity() == 1: global_dec_key += \"0\" else: global_dec_key += \"1\" r.close() AES_session_key = hex(int(global_dec_key[::-1], 2)[2:].replace(\"L\",\"\").zfill(32).decode(\"hex\") You can check out the entire exploit script here:\nfrom pwn import * from Crypto.Cipher import AES from Crypto.PublicKey import RSA from Crypto.Util.number import * def check_valid_request(s): try: s = s.split(\":\") except: return False if len(s) != 3: return False if s[0] != \"bi0s\": return False if s[1][:7] != \"userid=\": return False if s[2][:5] != \"user=\": return False return True def pad(s): s += chr(16 - len(s)%16)*(16 - len(s)%16) return s def send_enc_key(key): r.recvuntil(\"Enter encrypted key value in hex: \") send_key = hex(key)[2:].replace(\"L\",\"\") r.sendline(send_key) def send_enc_session(enc_session): r.recvuntil(\"Enter value of encrypted session request in hex: \") send_session = enc_session.encode(\"hex\") r.sendline(send_session) def check_enc_req_validity(): validity = r.recvuntil(\"!\").split(\"\\n\")[1] if validity == \"Valid request!\": return 1 elif validity == \"Invalid request!\": return 0 else: return -1 def encrypt_request(request, key, iv): if check_valid_request(request) == False: print \"Cannot encrypt invalid request\" return -1 obj1 = AES.new(key, AES.MODE_CBC, iv) ct = obj1.encrypt(pad(request)) return ct # Reading values from files key_enc = bytes_to_long(open(\"../Handout/key.enc\").read()) iv = open(\"iv.txt\").read() session_enc = open(\"../Handout/session.enc\").read() publickey = RSA.importKey(open(\"../Handout/publickey.pem\").read()) # Final decrypted key global_dec_key = \"\" # Pre-test: should return true r = remote(\"18.224.31.42\",\"1337\") key_payload = key_enc send_enc_key(key_payload) send_enc_session(session_enc) print \"[+] Pre-test results: \", check_enc_req_validity() r.close() # Exploit for i in range(127, -1, -1): r = remote(\"18.224.31.42\",\"1337\") key_payload = (key_enc*pow(2, i*publickey.e, publickey.n)) % publickey.n key_dec = hex(int(\"0\" + global_dec_key[::-1] + \"0\"*i, 2))[2:].replace(\"L\",\"\").zfill(32).decode(\"hex\") enc_session_payload = encrypt_request(\"bi0s:userid=test:user=test2\", key_dec, iv) # Sending the payload to the service send_enc_key(key_payload) send_enc_session(enc_session_payload) # Checking if the request is valid if check_enc_req_validity() == 1: global_dec_key += \"0\" else: global_dec_key += \"1\" r.close() AES_session_key = hex(int(global_dec_key[::-1], 2))[2:].replace(\"L\",\"\").zfill(32).decode(\"hex\") obj1 = AES.new(AES_session_key, AES.MODE_CBC, iv) print \"Here we go: \", obj1.decrypt(session_enc) Running this script will give us the flag as: inctf{y0u_eff1ng_CCA2_w1nn3r}\nReal World Example This vulnerability and attack was a part of research[1] done on Tencent‚Äôs QQ Browser, a popular mobile browser in China with hundreds of millions of users worldwide, by three professors- Thomas Ristenpart, Jedidah R. Crandall and Jeffrey Knockel. It was quite silly yet critical vulnerability in QQ Browser that they found. A small excerpt from the paper:\nWhen users run QQ Browser on Android, it makes a se- ries of what QQ Browser interally terms as ‚ÄúWUP re- quests‚Äù to QQ Browser‚Äôs server. These WUP requests contain information such as a user‚Äôs International Mobile Equipment Identifier (IMEI), International Mobile Sub- scriber Identification (IMSI), QQ username, WiFi MAC address, SSID of connected WiFi access point and of all in-range access points, Android ID, URLs of all web- pages visited, and other private information.\nThese requests were encrypted using a method similar to that in the challenge ‚ÄúRequest-Auth‚Äù with the same vulnerability (No padding and selecting only the least 16 bytes as the key) . This was a critical vulnerability as an attacker can decrypt any session and get access to personal, sensitive information stored in the request (IMEI, QQ username, WiFi MAC address, URLs of all web pages visited etc.)\n[1] https://arxiv.org/abs/1802.03367\nYCombinator news: https://news.ycombinator.com/item?id=16362488\nIt was after this paper got released, I decided to create a challenge based on it! Hope you enjoyed the challenge and the write-up! In case you have any queries or suggestions regarding the solution/write-up, you can reach me out on Twitter, or comment in the comments section below!\nChallenge Description\nThis was a crypto challenge based on Elliptic Curves that I created for InCTF-International 2018. In this challenge you are given two files: ecauth.py and ecsession.py, ecauth.py is basically a file implementing all the operations related to the Elliptic Curve (Point Addition, Scalar Multiplication): \\(y^2\\equivx^3+a*x+b\\mod p\\)\nThis challenge requires basic knowledge of Elliptic Curves to understand. In case you are not familiar with Elliptic Curves and want to learn, here are a few resources that can help you:\nhttp://andrea.corbellini.name/2015/05/17/elliptic-curve-cryptography-a-gentle-introduction/ https://github.com/ashutosh1206/Crypton/tree/master/Elliptic-Curves I took ecauth.py from https://bitcointalk.org/index.php?topic=23241.0 and modified it for the challenge. The modified part is:\nclass Public_key(object): def __init__(self, generator): self.generator = generator self.curve = generator.curve() n = generator.order() if not n: raise RuntimeError(\"Generator must have order\") if not n * generator == INFINITY: raise RuntimeError(\"Generator point order is bad\") if generator.x() \u003c 0 or n \u003c= generator.x() or generator.y() \u003c 0 or n \u003c= generator.y(): raise RuntimeError(\"Generator point has x or y out of range\") def check(self, point): k = self.generator.order() if not k: raise RuntimeError(\"Generator must have order\") if not k * point == INFINITY: raise RuntimeError(\"Generator point order is bad\") if point.x() \u003c 0 or k \u003c= point.x() or point.y() \u003c 0 or k \u003c= point.y(): raise RuntimeError(\"Generator point has x or y out of range\") def _verify(self, handshake): P = self.generator Q = handshake.Q R = handshake.R s = handshake.s try: self.check(Q) self.check(R) except: return False if (s*P).x() == (Q+R).x() and (s*P).y() == (Q+R).y(): return True else: return False class Private_key(object): def __init__(self, public_key, x): self.public_key = public_key self.privkey = x def _sign(self, r): P = self.public_key.generator Q = self.privkey * P R = r * P s = self.privkey + r return Handshake(Q, R, s) Let us analyse ecsession.py to understand things further:\n#!/usr/bin/env python2.7 from Crypto.Util.number import * from os import urandom import sys import ecauth from secret import flag, n class Unbuffered(object): def __init__(self, stream): self.stream = stream def write(self, data): self.stream.write(data) self.stream.flush() def writelines(self, datas): self.stream.writelines(datas) self.stream.flush() def __getattr__(self, attr): return getattr(self.stream, attr) sys.stdout = Unbuffered(sys.stdout) class colors: reset='\\033[0m' red='\\033[31m' green='\\033[32m' orange='\\033[33m' blue='\\033[34m' p = 89953523493328636138979614835438769105803101293517644103178299545319142490503 a = p-3 b = 28285296545714903834902884467158189217354728250629470479032309603102942404639 ec = ecauth.CurveFp(p, a, b) # Point P on the curve _Px = 0x337ef2115b4595fbd60e2ffb5ee6409463609e0e5a6611b105443e02cb82edd8L _Py = 0x1879b8d7a68a550f58166f0d6b4e86a0873d7b709e28ee318ddadd4ccf505e1aL # n is the order of the subgroup generated by (_Px, _Py) assert ec.contains_point(_Px, _Py) # x is the session-secret key x = getPrime(254) assert x \u003c n point_P = ecauth.Point(ec, _Px, _Py, n) assert point_P * n == ecauth.INFINITY publickey = ecauth.Public_key(point_P) privatekey = ecauth.Private_key(publickey, x) \"\"\" You can use the _sign method in ecauth to sign for authentication process. But remember, You must have the same x as generated in this script to successfully authenticate! \"\"\" print colors.orange + \"-\"*26 + \"Welcome to EC-Auth mechanism\" + \"-\"*26 + colors.reset point_Q = x * point_P print \"\\nHere is my point Q = x * P: \", point_Q try: _Rx = raw_input(\"\\nGive me x-coordinate of point R = r * P (in hex without 0x): \") _Ry = raw_input(\"Give me y-coordinate of point R = r * P (in hex without 0x): \") s = raw_input(\"Give me s = r + x (in hex without 0x): \") _Rx = int(_Rx, 16) _Ry = int(_Ry, 16) s = int(s, 16) except: print colors.red + \"\\nEnter proper hex values!\" + colors.reset sys.exit() if not ec.contains_point(_Rx, _Ry): print colors.red + \"\\nPoint R does not lie on the curve!\" + colors.reset sys.exit() point_R = ecauth.Point(ec, _Rx, _Ry) assert n * point_R == ecauth.INFINITY obj1 = ecauth.Handshake(point_Q, point_R, s) if publickey._verify(obj1): print colors.green + \"\\nHere, take your flag: \" + flag + colors.reset else: print colors.red + \"\\nI knew you would fail\" + colors.reset sys.exit() The script is trying to implement an authentication service similar to this: Since I could not think of ways in which the attacker would intercept such a communication in order to exploit it, I modified the above authetication process (keeping the concept as it is):\nThe curve used for the process is \\(y^2\\equiv x^3+a*x+b\\mod p\\), where p = 89953523493328636138979614835438769105803101293517644103178299545319142490503, a = p-3, and b = 28285296545714903834902884467158189217354728250629470479032309603102942404639\nServer takes a point on the curve P=(_Px, _Py), where _Px = 0x337ef2115b4595fbd60e2ffb5ee6409463609e0e5a6611b105443e02cb82edd8L, _Py = 0x1879b8d7a68a550f58166f0d6b4e86a0873d7b709e28ee318ddadd4ccf505e1aL\nServer generates point Q = x * P (consider it similar to a Prover generating Q and x is the secret key generated by the Prover using a pseudo random number generator) and gives the coordinates of Q.\nThe next step is intrusion of communication channel, so you being the attacker will have to give coordinates of R = r * P. If you are the prover, then you will have the value of r, but you are an attacker, so generating R such that the authentication passes, is the challenge üòâ\nAfter getting the value of R, server asks the value of s = x + r, which you can give as input. Again, you are not the prover (you won‚Äôt have the values of x and r, so the challenge again is, how do you get it?)\nThen the server calculates if s*P = Q + R, and returns the flag in case it evaluates to true, otherwise simply returns false\nThis will be true in case you are the prover because for true values of x and r, \\(s*P=(x+r)*P=(x*P)+(r*P)=Q+R\\) How can we accomplish this, as an attacker?\nReference: https://ecc2017.cs.ru.nl/slides/ecc2017school-smith.pdf\nimport ecauth from Crypto.Util.number import * p = 89953523493328636138979614835438769105803101293517644103178299545319142490503 a = p-3 b = 28285296545714903834902884467158189217354728250629470479032309603102942404639 ec = ecauth.CurveFp(p, a, b) # Point P on the curve _Px = 0x337ef2115b4595fbd60e2ffb5ee6409463609e0e5a6611b105443e02cb82edd8L _Py = 0x1879b8d7a68a550f58166f0d6b4e86a0873d7b709e28ee318ddadd4ccf505e1aL # Order of the subgroup generated by (_Px, _Py) n = 89953523493328636138979614835438769106005948670998555217484157791369906305783 assert ec.contains_point(_Px, _Py) point_P = ecauth.Point(ec, _Px, _Py, n) assert point_P * n == ecauth.INFINITY list_a = raw_input(\"Enter coordinates of Q: \").split(\",\") print list_a _Qx = int(list_a[0]) _Qy = int(list_a[1]) assert ec.contains_point(_Qx, _Qy) negative_Q = ecauth.Point(ec, _Qx, -_Qy, n) r_prime = getPrime(254) R_prime = r_prime * point_P print hex((R_prime + negative_Q).x())[2:].replace(\"L\",\"\") print hex((R_prime + negative_Q).y())[2:].replace(\"L\",\"\") print hex(r_prime)[2:].replace(\"L\",\"\") The output of this script, when given to the server as an input, gives us the flag: inctf{D4nger0us_eph3m3ral_k3ys!}\nLast year, around November I got a chance to learn Elliptic Curves at ECC Winter School, Nijmegen. It was after coming from there that I decided to make a challenge based on Ephemeral Keys (The attack was discussed in one of the sessions, taken by Benjamin Smith: https://ecc2017.cs.ru.nl/school.shtml, hence picture references to the slides ;)). I am and will always be grateful to the organising committee for giving me this opportunity and scholarship. Thanks!\nHope you enjoyed the challenge! If you have any queries related to any crypto challenge from InCTF International you can put it in the comments section, or ping me on Twitter!\n","wordCount":"2787","inLanguage":"en","datePublished":"2018-10-14T00:00:00Z","dateModified":"2018-10-14T00:00:00Z","author":{"@type":"Person","name":"Ashutosh Ahelleya"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ashutosh1206.github.io/ctf/inctfi18-crypto-part2/"},"publisher":{"@type":"Organization","name":"Ashutosh Ahelleya","logo":{"@type":"ImageObject","url":"https://ashutosh1206.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ashutosh1206.github.io/ accesskey=h title="Home (Alt + H)">Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://ashutosh1206.github.io/blog/ title=Blog><span>Blog</span></a></li><li><a href=https://ashutosh1206.github.io/archive/ title=Archive><span>Archive</span></a></li><li><a href=https://ashutosh1206.github.io/ctf/ title=CTF><span>CTF</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Crypto writeups [Part-2] - InCTFi 2018</h1><div class=post-meta><span title='2018-10-14 00:00:00 +0000 UTC'>October 14, 2018</span>&nbsp;¬∑&nbsp;Ashutosh Ahelleya</div></header><div class=post-content><p>This blog post covers intended solutions of two crypto challenges from InCTF-2018: <strong>Request-Auth</strong> and <strong>EC-Auth</strong>.</p><h1 id=request-auth>Request-Auth<a hidden class=anchor aria-hidden=true href=#request-auth>#</a></h1><p><img loading=lazy src=/inctfi18-crypto-part2-1.png alt=picture><br><em>Challenge Description</em></p><p>This was a medium level crypto challenge that I created for InCTF International-2018. In the challenge you are given multiple files: <code>iv.txt</code>, <code>key.enc</code>, <code>publickey.pem</code>, <code>ServerSide.py</code>, <code>session.enc</code> and also have a service running these files.</p><p>Contents of <code>ServerSide.py</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env python2.7</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> Crypto.Cipher <span style=color:#f92672>import</span> AES
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> Crypto.PublicKey <span style=color:#f92672>import</span> RSA
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> Crypto.Util.number <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> os <span style=color:#f92672>import</span> urandom
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> sys
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>BLOCKSIZE <span style=color:#f92672>=</span> <span style=color:#ae81ff>16</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Unbuffered</span>(object):
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>def</span> __init__(self, stream):
</span></span><span style=display:flex><span>       self<span style=color:#f92672>.</span>stream <span style=color:#f92672>=</span> stream
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>write</span>(self, data):
</span></span><span style=display:flex><span>       self<span style=color:#f92672>.</span>stream<span style=color:#f92672>.</span>write(data)
</span></span><span style=display:flex><span>       self<span style=color:#f92672>.</span>stream<span style=color:#f92672>.</span>flush()
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>writelines</span>(self, datas):
</span></span><span style=display:flex><span>       self<span style=color:#f92672>.</span>stream<span style=color:#f92672>.</span>writelines(datas)
</span></span><span style=display:flex><span>       self<span style=color:#f92672>.</span>stream<span style=color:#f92672>.</span>flush()
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>def</span> __getattr__(self, attr):
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> getattr(self<span style=color:#f92672>.</span>stream, attr)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sys<span style=color:#f92672>.</span>stdout <span style=color:#f92672>=</span> Unbuffered(sys<span style=color:#f92672>.</span>stdout)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>colors</span>:
</span></span><span style=display:flex><span>    reset<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\033</span><span style=color:#e6db74>[0m&#39;</span>
</span></span><span style=display:flex><span>    red<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\033</span><span style=color:#e6db74>[31m&#39;</span>
</span></span><span style=display:flex><span>    green<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\033</span><span style=color:#e6db74>[32m&#39;</span>
</span></span><span style=display:flex><span>    orange<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\033</span><span style=color:#e6db74>[33m&#39;</span>
</span></span><span style=display:flex><span>    blue<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\033</span><span style=color:#e6db74>[34m&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>unpad</span>(s):
</span></span><span style=display:flex><span>    s <span style=color:#f92672>=</span> s[:<span style=color:#f92672>-</span>ord(s[len(s) <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>])]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>check_valid_request</span>(s):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        s <span style=color:#f92672>=</span> s<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#34;:&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(s) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>3</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> s[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;bi0s&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> s[<span style=color:#ae81ff>1</span>][:<span style=color:#ae81ff>7</span>] <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;userid=&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> s[<span style=color:#ae81ff>2</span>][:<span style=color:#ae81ff>5</span>] <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;user=&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ServerSide</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, key, iv):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>key <span style=color:#f92672>=</span> key[<span style=color:#f92672>-</span><span style=color:#ae81ff>16</span>:]
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>iv <span style=color:#f92672>=</span> iv[<span style=color:#f92672>-</span><span style=color:#ae81ff>16</span>:]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>process_request</span>(self, req_enc):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>            obj2 <span style=color:#f92672>=</span> AES<span style=color:#f92672>.</span>new(self<span style=color:#f92672>.</span>key, AES<span style=color:#f92672>.</span>MODE_CBC, self<span style=color:#f92672>.</span>iv)
</span></span><span style=display:flex><span>            request <span style=color:#f92672>=</span> obj2<span style=color:#f92672>.</span>decrypt(req_enc)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> check_valid_request(request)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>except</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_AES_key</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        key_enc <span style=color:#f92672>=</span> raw_input(<span style=color:#e6db74>&#34;Enter encrypted key value in hex: &#34;</span>)
</span></span><span style=display:flex><span>        key_enc <span style=color:#f92672>=</span> int(key_enc, <span style=color:#ae81ff>16</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span>:
</span></span><span style=display:flex><span>        print colors<span style=color:#f92672>.</span>red <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;Enter valid input!&#34;</span> <span style=color:#f92672>+</span> colors<span style=color:#f92672>.</span>reset
</span></span><span style=display:flex><span>        sys<span style=color:#f92672>.</span>exit()
</span></span><span style=display:flex><span>    priv_key <span style=color:#f92672>=</span> RSA<span style=color:#f92672>.</span>importKey(open(<span style=color:#e6db74>&#34;privatekey.pem&#34;</span>)<span style=color:#f92672>.</span>read())
</span></span><span style=display:flex><span>    n, d <span style=color:#f92672>=</span> priv_key<span style=color:#f92672>.</span>n, priv_key<span style=color:#f92672>.</span>d
</span></span><span style=display:flex><span>    key_AES <span style=color:#f92672>=</span> pow(key_enc, d, n)
</span></span><span style=display:flex><span>    key_AES <span style=color:#f92672>=</span> long_to_bytes(key_AES)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> key_AES
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>string1 <span style=color:#f92672>=</span> colors<span style=color:#f92672>.</span>blue <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>$$\       $$\  $$$$$$</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>$$ |      \__|$$$ __$$</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>$$$$$$$\  $$\ $$$$\ $$ | $$$$$$$</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>$$  __$$\ $$ |$$\$$\$$ |$$  _____|
</span></span></span><span style=display:flex><span><span style=color:#e6db74>$$ |  $$ |$$ |$$ \$$$$ |\$$$$$$</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>$$ |  $$ |$$ |$$ |\$$$ | \____$$</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>$$$$$$$  |$$ |\$$$$$$  /$$$$$$$  |
</span></span></span><span style=display:flex><span><span style=color:#e6db74>\_______/ \__| \______/ \_______/
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;&#34;</span> <span style=color:#f92672>+</span> colors<span style=color:#f92672>.</span>reset
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    print colors<span style=color:#f92672>.</span>orange <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;Welcome to bi0s Request Validation Service&#34;</span> <span style=color:#f92672>+</span> colors<span style=color:#f92672>.</span>reset
</span></span><span style=display:flex><span>    print string1
</span></span><span style=display:flex><span>    key <span style=color:#f92672>=</span> get_AES_key()
</span></span><span style=display:flex><span>    iv <span style=color:#f92672>=</span> open(<span style=color:#e6db74>&#34;iv.txt&#34;</span>)<span style=color:#f92672>.</span>read()
</span></span><span style=display:flex><span>    obj1 <span style=color:#f92672>=</span> ServerSide(key, iv)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        ct <span style=color:#f92672>=</span> raw_input(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>Enter value of encrypted session request in hex: &#34;</span>)
</span></span><span style=display:flex><span>        ct <span style=color:#f92672>=</span> ct<span style=color:#f92672>.</span>decode(<span style=color:#e6db74>&#34;hex&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>TypeError</span>:
</span></span><span style=display:flex><span>        print colors<span style=color:#f92672>.</span>red <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;Enter a valid hex string!&#34;</span> <span style=color:#f92672>+</span> colors<span style=color:#f92672>.</span>reset
</span></span><span style=display:flex><span>        sys<span style=color:#f92672>.</span>exit()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> obj1<span style=color:#f92672>.</span>process_request(ct) <span style=color:#f92672>==</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>        print colors<span style=color:#f92672>.</span>green <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>Valid request!&#34;</span> <span style=color:#f92672>+</span> colors<span style=color:#f92672>.</span>reset
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>        print colors<span style=color:#f92672>.</span>red <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>Invalid request!&#34;</span> <span style=color:#f92672>+</span> colors<span style=color:#f92672>.</span>reset
</span></span></code></pre></div><p>Okay, so the service is basically implementing a hybrid cipher- a combination of RSA and AES to authenticate session requests coming from a user and is internally using a public and a private key in this process.</p><p><strong>ClientSide</strong>:</p><ol><li>For every new session, client generates a new valid request</li><li>The client encrypts the request <code>req</code> in AES-CBC mode using a 16-byte key <code>k</code> and 16-byte Initialisation Vector IV: \(session\_enc=E_{AES_{k, IV}}(req)\)</li><li>Client then encrypts the 16-byte AES key <code>k</code> using public-key of the server: \(key\_enc = k^e\mod n\)</li><li>In the final step, user gives the encrypted session <code>session_enc</code> and encrypted session-key <code>key_enc</code> as an input to the server</li></ol><p><strong>ServerSide</strong>:</p><ol><li>Server receives <code>session_enc</code> and <code>key_enc</code> from the Client.</li><li>Decrypts key_enc using it‚Äôs private key: \(k=key\_enc^d\mod n\)</li><li>Takes 16 least significant bytes of the resultant value of <code>k</code> as the key</li><li>Decrypts <code>session_enc</code> using value of key obtained from step-3: \(req=D_{AES_{k, IV}}(session\_enc)\)</li><li>Checks the validity of resultant request using check_valid_request() function.</li><li>Returns True if the request is valid, False if it isn‚Äôt.</li></ol><p>Had I been a participant trying to solve this challenge, I would have looked at check_valid_request(). Why? Because mostly in such functions, either there is an intentional vulnerability or you can find some unintended weakness that you can exploit. Let‚Äôs move to that part:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>check_valid_request</span>(s):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        s <span style=color:#f92672>=</span> s<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#34;:&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(s) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>3</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> s[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;bi0s&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> s[<span style=color:#ae81ff>1</span>][:<span style=color:#ae81ff>7</span>] <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;userid=&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> s[<span style=color:#ae81ff>2</span>][:<span style=color:#ae81ff>5</span>] <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;user=&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>True</span>
</span></span></code></pre></div><p>Doesn‚Äôt look like ^^ can be exploited. Dead end.</p><p>We know that the server only tells us if the request is valid or not, we won‚Äôt get a flag from the server directly in any case.</p><p>Either we find the server‚Äôs private key or we find the AES key using which ‚Äãsession.enc is encrypted. We are not able to factorise N, nor are we able to find any weakness in the public key, hence the only remaining option is to find the AES key.</p><p>How do we find it?</p><h2 id=the-vulnerability>The Vulnerability<a hidden class=anchor aria-hidden=true href=#the-vulnerability>#</a></h2><p>Remember how the server inputs encrypted key and evaluates the key to be used for encryption? Check out the first three steps happening on ServerSide:</p><ol><li>Receives <code>session_enc</code> and <code>key_enc</code> from the client.</li><li>Decrypts <code>key_enc</code> using it‚Äôs private key: \(k=key\_enc^d\mod n\)</li><li>Takes 16 least significant bytes of the resultant value of k as the key</li></ol><p>Do you see the weakness there? Step-3! <em>‚ÄúTakes 16 least significant bytes from resultant value of k obtained after decryption‚Äú</em>. Notice that we are in control of the encrypted AES key and hence we can do a chosen ciphertext attack. We have found the vulnerability, next question- how do we exploit it?</p><h2 id=the-exploit>The Exploit<a hidden class=anchor aria-hidden=true href=#the-exploit>#</a></h2><p>We know that: \(key\_enc = k^e\mod n\)</p><p>If we multiply <code>key_enc</code> by \(2^{me}\mod n\), we will have:
$$key\_enc * 2^{me} \mod n = k^e2^{me}\mod n$$
$$k^e2^{me}\mod n = (2^mk)^e\mod n$$</p><p>So, just by knowing the ciphertext of <code>k</code>, we can generate values of ciphertext of <code>2k</code>, <code>4k</code>, <code>8k</code>, &mldr; and so on. We also know that no matter how big the ciphertext is, the server will just take 16 least significant bytes of <code>k</code> after decryption.</p><p>We will denote \(key\_enc_m\equiv key\_enc*(2^m\mod n)\mod n\) and \(k_m\equiv k*2^m\mod n\)</p><p>Consider key_enc127 which is encryption of k127 where every bit but the most significant bit is zero. After sending key_enc127 to the server, upon decryption, only 16 least significant bytes are selected as the key for decrypting the session. This implies that k127‚Äòs most significant bit is k‚Äôs least significant bit. We assume that k127‚Äòs most significant bit is zero, encrypt the session with key that has least significant bit as 0 (Remaining all the bits are anyway zero) and send it to the server.</p><p>If the server responds with a ‚ÄúValid Response‚Äù message, then the least significant bit of the AES key is 0, otherwise it is 1. Next, we send key_enc126 which is the encryption of k126, encrypt a valid session with key where 0-125th bits from left are zero, 126th bit is zero and 127th bit is the least significant bit of ‚Äãk we got from previous iteration. Again, if the server responds with a ‚ÄúValid Response‚Äù message, then the second least significant bit of AES key is 0, otherwise it is 1.</p><p>We iterate this for key_enc125, key_enc124, &mldr;, key_enc0, until all the bits of k are obtained. I have implemented this step as a small python snippet:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>127</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>):
</span></span><span style=display:flex><span>    r <span style=color:#f92672>=</span> process(<span style=color:#e6db74>&#34;./run.sh&#34;</span>)
</span></span><span style=display:flex><span>    key_payload <span style=color:#f92672>=</span> (key_enc<span style=color:#f92672>*</span>pow(<span style=color:#ae81ff>2</span>, i<span style=color:#f92672>*</span>publickey<span style=color:#f92672>.</span>e, publickey<span style=color:#f92672>.</span>n)) <span style=color:#f92672>%</span> publickey<span style=color:#f92672>.</span>n
</span></span><span style=display:flex><span>    key_dec <span style=color:#f92672>=</span> hex(int(<span style=color:#e6db74>&#34;0&#34;</span> <span style=color:#f92672>+</span> global_dec_key[::<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;0&#34;</span><span style=color:#f92672>*</span>i, <span style=color:#ae81ff>2</span>))[<span style=color:#ae81ff>2</span>:]<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34;L&#34;</span>,<span style=color:#e6db74>&#34;&#34;</span>)<span style=color:#f92672>.</span>zfill(<span style=color:#ae81ff>32</span>)<span style=color:#f92672>.</span>decode(<span style=color:#e6db74>&#34;hex&#34;</span>)
</span></span><span style=display:flex><span>    enc_session_payload <span style=color:#f92672>=</span> encrypt_request(<span style=color:#e6db74>&#34;bi0s:userid=test:user=test2&#34;</span>, key_dec, iv)
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#75715e># Sending the payload to the service</span>
</span></span><span style=display:flex><span>    send_enc_key(key_payload)
</span></span><span style=display:flex><span>    send_enc_session(enc_session_payload)
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#75715e># Checking if the request is valid</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> check_enc_req_validity() <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>:
</span></span><span style=display:flex><span>         global_dec_key <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;0&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>         global_dec_key <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;1&#34;</span>
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>AES_session_key <span style=color:#f92672>=</span> hex(int(global_dec_key[::<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>], <span style=color:#ae81ff>2</span>)[<span style=color:#ae81ff>2</span>:]<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34;L&#34;</span>,<span style=color:#e6db74>&#34;&#34;</span>)<span style=color:#f92672>.</span>zfill(<span style=color:#ae81ff>32</span>)<span style=color:#f92672>.</span>decode(<span style=color:#e6db74>&#34;hex&#34;</span>)
</span></span></code></pre></div><p>You can check out the entire exploit script here:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> pwn <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> Crypto.Cipher <span style=color:#f92672>import</span> AES
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> Crypto.PublicKey <span style=color:#f92672>import</span> RSA
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> Crypto.Util.number <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>check_valid_request</span>(s):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        s <span style=color:#f92672>=</span> s<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#34;:&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(s) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>3</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> s[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;bi0s&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> s[<span style=color:#ae81ff>1</span>][:<span style=color:#ae81ff>7</span>] <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;userid=&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> s[<span style=color:#ae81ff>2</span>][:<span style=color:#ae81ff>5</span>] <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;user=&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>pad</span>(s):
</span></span><span style=display:flex><span>    s <span style=color:#f92672>+=</span> chr(<span style=color:#ae81ff>16</span> <span style=color:#f92672>-</span> len(s)<span style=color:#f92672>%</span><span style=color:#ae81ff>16</span>)<span style=color:#f92672>*</span>(<span style=color:#ae81ff>16</span> <span style=color:#f92672>-</span> len(s)<span style=color:#f92672>%</span><span style=color:#ae81ff>16</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> s
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>send_enc_key</span>(key):
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>&#34;Enter encrypted key value in hex: &#34;</span>)
</span></span><span style=display:flex><span>    send_key <span style=color:#f92672>=</span> hex(key)[<span style=color:#ae81ff>2</span>:]<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34;L&#34;</span>,<span style=color:#e6db74>&#34;&#34;</span>)
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>sendline(send_key)
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>send_enc_session</span>(enc_session):
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>&#34;Enter value of encrypted session request in hex: &#34;</span>)
</span></span><span style=display:flex><span>    send_session <span style=color:#f92672>=</span> enc_session<span style=color:#f92672>.</span>encode(<span style=color:#e6db74>&#34;hex&#34;</span>)
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>sendline(send_session)
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>check_enc_req_validity</span>():
</span></span><span style=display:flex><span>    validity <span style=color:#f92672>=</span> r<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>&#34;!&#34;</span>)<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>)[<span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> validity <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Valid request!&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>elif</span> validity <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Invalid request!&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>encrypt_request</span>(request, key, iv):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> check_valid_request(request) <span style=color:#f92672>==</span> <span style=color:#66d9ef>False</span>:
</span></span><span style=display:flex><span>        print <span style=color:#e6db74>&#34;Cannot encrypt invalid request&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    obj1 <span style=color:#f92672>=</span> AES<span style=color:#f92672>.</span>new(key, AES<span style=color:#f92672>.</span>MODE_CBC, iv)
</span></span><span style=display:flex><span>    ct <span style=color:#f92672>=</span> obj1<span style=color:#f92672>.</span>encrypt(pad(request))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> ct
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#75715e># Reading values from files</span>
</span></span><span style=display:flex><span>key_enc <span style=color:#f92672>=</span> bytes_to_long(open(<span style=color:#e6db74>&#34;../Handout/key.enc&#34;</span>)<span style=color:#f92672>.</span>read())
</span></span><span style=display:flex><span>iv <span style=color:#f92672>=</span> open(<span style=color:#e6db74>&#34;iv.txt&#34;</span>)<span style=color:#f92672>.</span>read()
</span></span><span style=display:flex><span>session_enc <span style=color:#f92672>=</span> open(<span style=color:#e6db74>&#34;../Handout/session.enc&#34;</span>)<span style=color:#f92672>.</span>read()
</span></span><span style=display:flex><span>publickey <span style=color:#f92672>=</span> RSA<span style=color:#f92672>.</span>importKey(open(<span style=color:#e6db74>&#34;../Handout/publickey.pem&#34;</span>)<span style=color:#f92672>.</span>read())
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#75715e># Final decrypted key</span>
</span></span><span style=display:flex><span>global_dec_key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#75715e># Pre-test: should return true</span>
</span></span><span style=display:flex><span>r <span style=color:#f92672>=</span> remote(<span style=color:#e6db74>&#34;18.224.31.42&#34;</span>,<span style=color:#e6db74>&#34;1337&#34;</span>)
</span></span><span style=display:flex><span>key_payload <span style=color:#f92672>=</span> key_enc
</span></span><span style=display:flex><span>send_enc_key(key_payload)
</span></span><span style=display:flex><span>send_enc_session(session_enc)
</span></span><span style=display:flex><span>print <span style=color:#e6db74>&#34;[+] Pre-test results: &#34;</span>, check_enc_req_validity()
</span></span><span style=display:flex><span>r<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#75715e># Exploit</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>127</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>):
</span></span><span style=display:flex><span>    r <span style=color:#f92672>=</span> remote(<span style=color:#e6db74>&#34;18.224.31.42&#34;</span>,<span style=color:#e6db74>&#34;1337&#34;</span>)
</span></span><span style=display:flex><span>    key_payload <span style=color:#f92672>=</span> (key_enc<span style=color:#f92672>*</span>pow(<span style=color:#ae81ff>2</span>, i<span style=color:#f92672>*</span>publickey<span style=color:#f92672>.</span>e, publickey<span style=color:#f92672>.</span>n)) <span style=color:#f92672>%</span> publickey<span style=color:#f92672>.</span>n
</span></span><span style=display:flex><span>    key_dec <span style=color:#f92672>=</span> hex(int(<span style=color:#e6db74>&#34;0&#34;</span> <span style=color:#f92672>+</span> global_dec_key[::<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;0&#34;</span><span style=color:#f92672>*</span>i, <span style=color:#ae81ff>2</span>))[<span style=color:#ae81ff>2</span>:]<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34;L&#34;</span>,<span style=color:#e6db74>&#34;&#34;</span>)<span style=color:#f92672>.</span>zfill(<span style=color:#ae81ff>32</span>)<span style=color:#f92672>.</span>decode(<span style=color:#e6db74>&#34;hex&#34;</span>)
</span></span><span style=display:flex><span>    enc_session_payload <span style=color:#f92672>=</span> encrypt_request(<span style=color:#e6db74>&#34;bi0s:userid=test:user=test2&#34;</span>, key_dec, iv)
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#75715e># Sending the payload to the service</span>
</span></span><span style=display:flex><span>    send_enc_key(key_payload)
</span></span><span style=display:flex><span>    send_enc_session(enc_session_payload)
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#75715e># Checking if the request is valid</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> check_enc_req_validity() <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>:
</span></span><span style=display:flex><span>         global_dec_key <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;0&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>         global_dec_key <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;1&#34;</span>
</span></span><span style=display:flex><span>    r<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>AES_session_key <span style=color:#f92672>=</span> hex(int(global_dec_key[::<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>], <span style=color:#ae81ff>2</span>))[<span style=color:#ae81ff>2</span>:]<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34;L&#34;</span>,<span style=color:#e6db74>&#34;&#34;</span>)<span style=color:#f92672>.</span>zfill(<span style=color:#ae81ff>32</span>)<span style=color:#f92672>.</span>decode(<span style=color:#e6db74>&#34;hex&#34;</span>)
</span></span><span style=display:flex><span>obj1 <span style=color:#f92672>=</span> AES<span style=color:#f92672>.</span>new(AES_session_key, AES<span style=color:#f92672>.</span>MODE_CBC, iv)
</span></span><span style=display:flex><span>print <span style=color:#e6db74>&#34;Here we go: &#34;</span>, obj1<span style=color:#f92672>.</span>decrypt(session_enc)
</span></span></code></pre></div><p>Running this script will give us the flag as: <strong>inctf{y0u_eff1ng_CCA2_w1nn3r}</strong></p><h2 id=real-world-example>Real World Example<a hidden class=anchor aria-hidden=true href=#real-world-example>#</a></h2><p>This vulnerability and attack was a part of research[1] done on Tencent‚Äôs QQ Browser, a popular mobile browser in China with hundreds of millions of users worldwide, by three professors- Thomas Ristenpart, Jedidah R. Crandall and Jeffrey Knockel. It was quite silly yet critical vulnerability in QQ Browser that they found. A small excerpt from the paper:</p><blockquote><p>When users run QQ Browser on Android, it makes a se-
ries of what QQ Browser interally terms as ‚ÄúWUP re-
quests‚Äù to QQ Browser‚Äôs server. These WUP requests
contain information such as a user‚Äôs International Mobile
Equipment Identifier (IMEI), International Mobile Sub-
scriber Identification (IMSI), QQ username, WiFi MAC
address, SSID of connected WiFi access point and of all
in-range access points, Android ID, URLs of all web-
pages visited, and other private information.</p></blockquote><p>These requests were encrypted using a method similar to that in the challenge ‚ÄúRequest-Auth‚Äù with the same vulnerability (No padding and selecting only the least 16 bytes as the key) . This was a critical vulnerability as an attacker can decrypt any session and get access to personal, sensitive information stored in the request (IMEI, QQ username, WiFi MAC address, URLs of all web pages visited etc.)</p><p>[1] <a href=https://arxiv.org/abs/1802.03367>https://arxiv.org/abs/1802.03367</a></p><p><strong>YCombinator news</strong>: <a href="https://news.ycombinator.com/item?id=16362488">https://news.ycombinator.com/item?id=16362488</a></p><p>It was after this paper got released, I decided to create a challenge based on it! Hope you enjoyed the challenge and the write-up! In case you have any queries or suggestions regarding the solution/write-up, you can <a href=https://twitter.com/ashutosha_>reach me out on Twitter</a>, or comment in the comments section below!</p><p><img loading=lazy src=/inctfi18-crypto-part2-2.png alt=picture><br><em>Challenge Description</em></p><p>This was a crypto challenge based on Elliptic Curves that I created for InCTF-International 2018. In this challenge you are given two files: <code>ecauth.py</code> and <code>ecsession.py</code>, <code>ecauth.py</code> is basically a file implementing all the operations related to the Elliptic Curve (Point Addition, Scalar Multiplication): \(y^2\equivx^3+a*x+b\mod p\)</p><p>This challenge requires basic knowledge of Elliptic Curves to understand. In case you are not familiar with Elliptic Curves and want to learn, here are a few resources that can help you:</p><ol><li><a href=http://andrea.corbellini.name/2015/05/17/elliptic-curve-cryptography-a-gentle-introduction/>http://andrea.corbellini.name/2015/05/17/elliptic-curve-cryptography-a-gentle-introduction/</a></li><li><a href=https://github.com/ashutosh1206/Crypton/tree/master/Elliptic-Curves>https://github.com/ashutosh1206/Crypton/tree/master/Elliptic-Curves</a></li></ol><p>I took ecauth.py from <a href="https://bitcointalk.org/index.php?topic=23241.0">https://bitcointalk.org/index.php?topic=23241.0</a> and modified it for the challenge. The modified part is:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Public_key</span>(object):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, generator):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>generator <span style=color:#f92672>=</span> generator
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>curve <span style=color:#f92672>=</span> generator<span style=color:#f92672>.</span>curve()
</span></span><span style=display:flex><span>        n <span style=color:#f92672>=</span> generator<span style=color:#f92672>.</span>order()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> n:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>RuntimeError</span>(<span style=color:#e6db74>&#34;Generator must have order&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> n <span style=color:#f92672>*</span> generator <span style=color:#f92672>==</span> INFINITY:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>RuntimeError</span>(<span style=color:#e6db74>&#34;Generator point order is bad&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> generator<span style=color:#f92672>.</span>x() <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>or</span> n <span style=color:#f92672>&lt;=</span> generator<span style=color:#f92672>.</span>x() <span style=color:#f92672>or</span>  generator<span style=color:#f92672>.</span>y() <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>or</span> n <span style=color:#f92672>&lt;=</span> generator<span style=color:#f92672>.</span>y():
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>RuntimeError</span>(<span style=color:#e6db74>&#34;Generator point has x or y out of range&#34;</span>)
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>check</span>(self, point):
</span></span><span style=display:flex><span>        k <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>generator<span style=color:#f92672>.</span>order()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> k:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>RuntimeError</span>(<span style=color:#e6db74>&#34;Generator must have order&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> k <span style=color:#f92672>*</span> point <span style=color:#f92672>==</span> INFINITY:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>RuntimeError</span>(<span style=color:#e6db74>&#34;Generator point order is bad&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> point<span style=color:#f92672>.</span>x() <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>or</span> k <span style=color:#f92672>&lt;=</span> point<span style=color:#f92672>.</span>x() <span style=color:#f92672>or</span>  point<span style=color:#f92672>.</span>y() <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>or</span> k <span style=color:#f92672>&lt;=</span> point<span style=color:#f92672>.</span>y():
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>RuntimeError</span>(<span style=color:#e6db74>&#34;Generator point has x or y out of range&#34;</span>)
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_verify</span>(self, handshake):
</span></span><span style=display:flex><span>        P <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>generator
</span></span><span style=display:flex><span>        Q <span style=color:#f92672>=</span> handshake<span style=color:#f92672>.</span>Q
</span></span><span style=display:flex><span>        R <span style=color:#f92672>=</span> handshake<span style=color:#f92672>.</span>R
</span></span><span style=display:flex><span>        s <span style=color:#f92672>=</span> handshake<span style=color:#f92672>.</span>s
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>check(Q)
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>check(R)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>except</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (s<span style=color:#f92672>*</span>P)<span style=color:#f92672>.</span>x() <span style=color:#f92672>==</span> (Q<span style=color:#f92672>+</span>R)<span style=color:#f92672>.</span>x() <span style=color:#f92672>and</span> (s<span style=color:#f92672>*</span>P)<span style=color:#f92672>.</span>y() <span style=color:#f92672>==</span> (Q<span style=color:#f92672>+</span>R)<span style=color:#f92672>.</span>y():
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Private_key</span>(object):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, public_key, x):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>public_key <span style=color:#f92672>=</span> public_key
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>privkey <span style=color:#f92672>=</span> x
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_sign</span>(self, r):
</span></span><span style=display:flex><span>        P <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>public_key<span style=color:#f92672>.</span>generator
</span></span><span style=display:flex><span>        Q <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>privkey <span style=color:#f92672>*</span> P
</span></span><span style=display:flex><span>        R <span style=color:#f92672>=</span> r <span style=color:#f92672>*</span> P
</span></span><span style=display:flex><span>        s <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>privkey <span style=color:#f92672>+</span> r
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Handshake(Q, R, s)
</span></span></code></pre></div><p>Let us analyse <code>ecsession.py</code> to understand things further:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env python2.7</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> Crypto.Util.number <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> os <span style=color:#f92672>import</span> urandom
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> sys
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> ecauth
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> secret <span style=color:#f92672>import</span> flag, n
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Unbuffered</span>(object):
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>def</span> __init__(self, stream):
</span></span><span style=display:flex><span>       self<span style=color:#f92672>.</span>stream <span style=color:#f92672>=</span> stream
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>write</span>(self, data):
</span></span><span style=display:flex><span>       self<span style=color:#f92672>.</span>stream<span style=color:#f92672>.</span>write(data)
</span></span><span style=display:flex><span>       self<span style=color:#f92672>.</span>stream<span style=color:#f92672>.</span>flush()
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>writelines</span>(self, datas):
</span></span><span style=display:flex><span>       self<span style=color:#f92672>.</span>stream<span style=color:#f92672>.</span>writelines(datas)
</span></span><span style=display:flex><span>       self<span style=color:#f92672>.</span>stream<span style=color:#f92672>.</span>flush()
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>def</span> __getattr__(self, attr):
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> getattr(self<span style=color:#f92672>.</span>stream, attr)
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>sys<span style=color:#f92672>.</span>stdout <span style=color:#f92672>=</span> Unbuffered(sys<span style=color:#f92672>.</span>stdout)
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>colors</span>:
</span></span><span style=display:flex><span>    reset<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\033</span><span style=color:#e6db74>[0m&#39;</span>
</span></span><span style=display:flex><span>    red<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\033</span><span style=color:#e6db74>[31m&#39;</span>
</span></span><span style=display:flex><span>    green<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\033</span><span style=color:#e6db74>[32m&#39;</span>
</span></span><span style=display:flex><span>    orange<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\033</span><span style=color:#e6db74>[33m&#39;</span>
</span></span><span style=display:flex><span>    blue<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\033</span><span style=color:#e6db74>[34m&#39;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>p <span style=color:#f92672>=</span> <span style=color:#ae81ff>89953523493328636138979614835438769105803101293517644103178299545319142490503</span>
</span></span><span style=display:flex><span>a <span style=color:#f92672>=</span> p<span style=color:#f92672>-</span><span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>b <span style=color:#f92672>=</span> <span style=color:#ae81ff>28285296545714903834902884467158189217354728250629470479032309603102942404639</span>
</span></span><span style=display:flex><span>ec <span style=color:#f92672>=</span> ecauth<span style=color:#f92672>.</span>CurveFp(p, a, b)
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#75715e># Point P on the curve</span>
</span></span><span style=display:flex><span>_Px <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x337ef2115b4595fbd60e2ffb5ee6409463609e0e5a6611b105443e02cb82edd8</span>L
</span></span><span style=display:flex><span>_Py <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x1879b8d7a68a550f58166f0d6b4e86a0873d7b709e28ee318ddadd4ccf505e1a</span>L
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#75715e># n is the order of the subgroup generated by (_Px, _Py)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>assert</span> ec<span style=color:#f92672>.</span>contains_point(_Px, _Py)
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#75715e># x is the session-secret key</span>
</span></span><span style=display:flex><span>x <span style=color:#f92672>=</span> getPrime(<span style=color:#ae81ff>254</span>)
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>assert</span> x <span style=color:#f92672>&lt;</span> n
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>point_P <span style=color:#f92672>=</span> ecauth<span style=color:#f92672>.</span>Point(ec, _Px, _Py, n)
</span></span><span style=display:flex><span><span style=color:#66d9ef>assert</span> point_P <span style=color:#f92672>*</span> n <span style=color:#f92672>==</span> ecauth<span style=color:#f92672>.</span>INFINITY
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>publickey <span style=color:#f92672>=</span> ecauth<span style=color:#f92672>.</span>Public_key(point_P)
</span></span><span style=display:flex><span>privatekey <span style=color:#f92672>=</span> ecauth<span style=color:#f92672>.</span>Private_key(publickey, x)
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>You can use the _sign method in ecauth to sign for authentication process.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>But remember,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>You must have the same x as generated in this script to successfully authenticate!
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>print colors<span style=color:#f92672>.</span>orange <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;-&#34;</span><span style=color:#f92672>*</span><span style=color:#ae81ff>26</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;Welcome to EC-Auth mechanism&#34;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;-&#34;</span><span style=color:#f92672>*</span><span style=color:#ae81ff>26</span> <span style=color:#f92672>+</span> colors<span style=color:#f92672>.</span>reset
</span></span><span style=display:flex><span>point_Q <span style=color:#f92672>=</span> x <span style=color:#f92672>*</span> point_P
</span></span><span style=display:flex><span>print <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>Here is my point Q = x * P: &#34;</span>, point_Q
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>    _Rx <span style=color:#f92672>=</span> raw_input(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>Give me x-coordinate of point R = r * P (in hex without 0x): &#34;</span>)
</span></span><span style=display:flex><span>    _Ry <span style=color:#f92672>=</span> raw_input(<span style=color:#e6db74>&#34;Give me y-coordinate of point R = r * P (in hex without 0x): &#34;</span>)
</span></span><span style=display:flex><span>    s <span style=color:#f92672>=</span> raw_input(<span style=color:#e6db74>&#34;Give me s = r + x (in hex without 0x): &#34;</span>)
</span></span><span style=display:flex><span>    _Rx <span style=color:#f92672>=</span> int(_Rx, <span style=color:#ae81ff>16</span>)
</span></span><span style=display:flex><span>    _Ry <span style=color:#f92672>=</span> int(_Ry, <span style=color:#ae81ff>16</span>)
</span></span><span style=display:flex><span>    s <span style=color:#f92672>=</span> int(s, <span style=color:#ae81ff>16</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>except</span>:
</span></span><span style=display:flex><span>    print colors<span style=color:#f92672>.</span>red <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>Enter proper hex values!&#34;</span> <span style=color:#f92672>+</span> colors<span style=color:#f92672>.</span>reset
</span></span><span style=display:flex><span>    sys<span style=color:#f92672>.</span>exit()
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> ec<span style=color:#f92672>.</span>contains_point(_Rx, _Ry):
</span></span><span style=display:flex><span>    print colors<span style=color:#f92672>.</span>red <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>Point R does not lie on the curve!&#34;</span> <span style=color:#f92672>+</span> colors<span style=color:#f92672>.</span>reset
</span></span><span style=display:flex><span>    sys<span style=color:#f92672>.</span>exit()
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>point_R <span style=color:#f92672>=</span> ecauth<span style=color:#f92672>.</span>Point(ec, _Rx, _Ry)
</span></span><span style=display:flex><span><span style=color:#66d9ef>assert</span> n <span style=color:#f92672>*</span> point_R <span style=color:#f92672>==</span> ecauth<span style=color:#f92672>.</span>INFINITY
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>obj1 <span style=color:#f92672>=</span> ecauth<span style=color:#f92672>.</span>Handshake(point_Q, point_R, s)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> publickey<span style=color:#f92672>.</span>_verify(obj1):
</span></span><span style=display:flex><span>    print colors<span style=color:#f92672>.</span>green <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>Here, take your flag: &#34;</span> <span style=color:#f92672>+</span> flag <span style=color:#f92672>+</span> colors<span style=color:#f92672>.</span>reset
</span></span><span style=display:flex><span><span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>    print colors<span style=color:#f92672>.</span>red <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>I knew you would fail&#34;</span> <span style=color:#f92672>+</span> colors<span style=color:#f92672>.</span>reset
</span></span><span style=display:flex><span>    sys<span style=color:#f92672>.</span>exit()
</span></span></code></pre></div><p>The script is trying to implement an authentication service similar to this:
<img loading=lazy src=/inctfi18-crypto-part2-3.png alt=picture></p><p>Since I could not think of ways in which the attacker would intercept such a communication in order to exploit it, I modified the above authetication process (keeping the concept as it is):</p><ol><li><p>The curve used for the process is \(y^2\equiv x^3+a*x+b\mod p\), where p = 89953523493328636138979614835438769105803101293517644103178299545319142490503, a = p-3, and b = 28285296545714903834902884467158189217354728250629470479032309603102942404639</p></li><li><p>Server takes a point on the curve P=(_Px, _Py), where _Px = 0x337ef2115b4595fbd60e2ffb5ee6409463609e0e5a6611b105443e02cb82edd8L, _Py = 0x1879b8d7a68a550f58166f0d6b4e86a0873d7b709e28ee318ddadd4ccf505e1aL</p></li><li><p>Server generates point Q = x * P (consider it similar to a Prover generating Q and x is the secret key generated by the Prover using a pseudo random number generator) and gives the coordinates of Q.</p></li><li><p>The next step is intrusion of communication channel, so you being the attacker will have to give coordinates of R = r * P. If you are the prover, then you will have the value of r, but you are an attacker, so generating R such that the authentication passes, is the challenge üòâ</p></li><li><p>After getting the value of R, server asks the value of s = x + r, which you can give as input. Again, you are not the prover (you won‚Äôt have the values of x and r, so the challenge again is, how do you get it?)</p></li><li><p>Then the server calculates if s*P = Q + R, and returns the flag in case it evaluates to true, otherwise simply returns false</p><ul><li>This will be true in case you are the prover because for true values of x and r, \(s*P=(x+r)*P=(x*P)+(r*P)=Q+R\)</li></ul></li></ol><p>How can we accomplish this, as an attacker?</p><p><img loading=lazy src=/inctfi18-crypto-part2-4.png alt=picture><br><em>Reference: <a href=https://ecc2017.cs.ru.nl/slides/ecc2017school-smith.pdf>https://ecc2017.cs.ru.nl/slides/ecc2017school-smith.pdf</a></em></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> ecauth
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> Crypto.Util.number <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>p <span style=color:#f92672>=</span> <span style=color:#ae81ff>89953523493328636138979614835438769105803101293517644103178299545319142490503</span>
</span></span><span style=display:flex><span>a <span style=color:#f92672>=</span> p<span style=color:#f92672>-</span><span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>b <span style=color:#f92672>=</span> <span style=color:#ae81ff>28285296545714903834902884467158189217354728250629470479032309603102942404639</span>
</span></span><span style=display:flex><span>ec <span style=color:#f92672>=</span> ecauth<span style=color:#f92672>.</span>CurveFp(p, a, b)
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#75715e># Point P on the curve</span>
</span></span><span style=display:flex><span>_Px <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x337ef2115b4595fbd60e2ffb5ee6409463609e0e5a6611b105443e02cb82edd8</span>L
</span></span><span style=display:flex><span>_Py <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x1879b8d7a68a550f58166f0d6b4e86a0873d7b709e28ee318ddadd4ccf505e1a</span>L
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#75715e># Order of the subgroup generated by (_Px, _Py)</span>
</span></span><span style=display:flex><span>n <span style=color:#f92672>=</span> <span style=color:#ae81ff>89953523493328636138979614835438769106005948670998555217484157791369906305783</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>assert</span> ec<span style=color:#f92672>.</span>contains_point(_Px, _Py)
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>point_P <span style=color:#f92672>=</span> ecauth<span style=color:#f92672>.</span>Point(ec, _Px, _Py, n)
</span></span><span style=display:flex><span><span style=color:#66d9ef>assert</span> point_P <span style=color:#f92672>*</span> n <span style=color:#f92672>==</span> ecauth<span style=color:#f92672>.</span>INFINITY
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>list_a <span style=color:#f92672>=</span> raw_input(<span style=color:#e6db74>&#34;Enter coordinates of Q: &#34;</span>)<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#34;,&#34;</span>)
</span></span><span style=display:flex><span>print list_a
</span></span><span style=display:flex><span>_Qx <span style=color:#f92672>=</span> int(list_a[<span style=color:#ae81ff>0</span>])
</span></span><span style=display:flex><span>_Qy <span style=color:#f92672>=</span> int(list_a[<span style=color:#ae81ff>1</span>])
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>assert</span> ec<span style=color:#f92672>.</span>contains_point(_Qx, _Qy)
</span></span><span style=display:flex><span>negative_Q <span style=color:#f92672>=</span> ecauth<span style=color:#f92672>.</span>Point(ec, _Qx, <span style=color:#f92672>-</span>_Qy, n)
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>r_prime <span style=color:#f92672>=</span> getPrime(<span style=color:#ae81ff>254</span>)
</span></span><span style=display:flex><span>R_prime <span style=color:#f92672>=</span> r_prime <span style=color:#f92672>*</span> point_P
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>print hex((R_prime <span style=color:#f92672>+</span> negative_Q)<span style=color:#f92672>.</span>x())[<span style=color:#ae81ff>2</span>:]<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34;L&#34;</span>,<span style=color:#e6db74>&#34;&#34;</span>)
</span></span><span style=display:flex><span>print hex((R_prime <span style=color:#f92672>+</span> negative_Q)<span style=color:#f92672>.</span>y())[<span style=color:#ae81ff>2</span>:]<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34;L&#34;</span>,<span style=color:#e6db74>&#34;&#34;</span>)
</span></span><span style=display:flex><span>print hex(r_prime)[<span style=color:#ae81ff>2</span>:]<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34;L&#34;</span>,<span style=color:#e6db74>&#34;&#34;</span>)
</span></span></code></pre></div><p>The output of this script, when given to the server as an input, gives us the flag: <strong>inctf{D4nger0us_eph3m3ral_k3ys!}</strong></p><p>Last year, around November I got a chance to learn Elliptic Curves at ECC Winter School, Nijmegen. It was after coming from there that I decided to make a challenge based on Ephemeral Keys (The attack was discussed in one of the sessions, taken by Benjamin Smith: <a href=https://ecc2017.cs.ru.nl/school.shtml>https://ecc2017.cs.ru.nl/school.shtml</a>, hence picture references to the slides ;)). I am and will always be grateful to the organising committee for giving me this opportunity and scholarship. Thanks!</p><p>Hope you enjoyed the challenge! If you have any queries related to any crypto challenge from InCTF International you can put it in the comments section, or <a href=https://twitter.com/ashutosha_>ping me on Twitter</a>!</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://ashutosh1206.github.io/tags/elliptic-curves/>Elliptic-Curves</a></li><li><a href=https://ashutosh1206.github.io/tags/rsa/>RSA</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://ashutosh1206.github.io/>Ashutosh Ahelleya</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>