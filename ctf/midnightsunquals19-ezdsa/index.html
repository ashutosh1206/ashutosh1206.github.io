<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>EZDSA - Midnight Sun CTF Quals | Ash&#39;s blog</title>
<meta name="keywords" content="NumberTheory">
<meta name="description" content="Challenge Points: 223
Challenge Description:
Someone told me not to use DSA, so I came up with this.
In this challenge, we are given a script that signs any message given as an input:
class PrivateSigningKey: def __init__(self): self.gen = 0x44120dc98545c6d3d81bfc7898983e7b7f6ac8e08d3943af0be7f5d52264abb3775a905e003151ed0631376165b65c8ef72d0b6880da7e4b5e7b833377bb50fde65846426a5bfdc182673b6b2504ebfe0d6bca36338b3a3be334689c1afb17869baeb2b0380351b61555df31f0cda3445bba4023be72a494588d640a9da7bd16L self.q = 0x926c99d24bd4d5b47adb75bd9933de8be5932f4bL self.p = 0x80000000000001cda6f403d8a752a4e7976173ebfcd2acf69a29f4bada1ca3178b56131c2c1f00cf7875a2e7c497b10fea66b26436e40b7b73952081319e26603810a558f871d6d256fddbec5933b77fa7d1d0d75267dcae1f24ea7cc57b3a30f8ea09310772440f016c13e08b56b1196a687d6a5e5de864068f3fd936a361c5L self.key = int(FLAG.encode(&#34;hex&#34;), 16) def sign(self, m): def bytes_to_long(b): return long(b.encode(&#34;hex&#34;), 16) h = bytes_to_long(sha1(m).digest()) u = bytes_to_long(Random.new().read(20)) assert(bytes_to_long(m) % (self.q - 1) !">
<meta name="author" content="Ashutosh Ahelleya">
<link rel="canonical" href="https://ashutosh1206.github.io/ctf/midnightsunquals19-ezdsa/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.bccfefac377bc340f06c260aed1bddf49a4354816d7c570d6aac75a997986c95.css" integrity="sha256-vM/vrDd7w0DwbCYK7Rvd9JpDVIFtfFcNaqx1qZeYbJU=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://ashutosh1206.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://ashutosh1206.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://ashutosh1206.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://ashutosh1206.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://ashutosh1206.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css" integrity="sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0" crossorigin="anonymous">

<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js" integrity="sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4" crossorigin="anonymous"></script>

<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"
    onload="renderMathInElement(document.body);"></script>
<meta property="og:title" content="EZDSA - Midnight Sun CTF Quals" />
<meta property="og:description" content="Challenge Points: 223
Challenge Description:
Someone told me not to use DSA, so I came up with this.
In this challenge, we are given a script that signs any message given as an input:
class PrivateSigningKey: def __init__(self): self.gen = 0x44120dc98545c6d3d81bfc7898983e7b7f6ac8e08d3943af0be7f5d52264abb3775a905e003151ed0631376165b65c8ef72d0b6880da7e4b5e7b833377bb50fde65846426a5bfdc182673b6b2504ebfe0d6bca36338b3a3be334689c1afb17869baeb2b0380351b61555df31f0cda3445bba4023be72a494588d640a9da7bd16L self.q = 0x926c99d24bd4d5b47adb75bd9933de8be5932f4bL self.p = 0x80000000000001cda6f403d8a752a4e7976173ebfcd2acf69a29f4bada1ca3178b56131c2c1f00cf7875a2e7c497b10fea66b26436e40b7b73952081319e26603810a558f871d6d256fddbec5933b77fa7d1d0d75267dcae1f24ea7cc57b3a30f8ea09310772440f016c13e08b56b1196a687d6a5e5de864068f3fd936a361c5L self.key = int(FLAG.encode(&#34;hex&#34;), 16) def sign(self, m): def bytes_to_long(b): return long(b.encode(&#34;hex&#34;), 16) h = bytes_to_long(sha1(m).digest()) u = bytes_to_long(Random.new().read(20)) assert(bytes_to_long(m) % (self.q - 1) !" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ashutosh1206.github.io/ctf/midnightsunquals19-ezdsa/" /><meta property="article:section" content="ctf" />
<meta property="article:published_time" content="2019-04-09T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-04-09T00:00:00+00:00" /><meta property="og:site_name" content="Ash&#39;s blog" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="EZDSA - Midnight Sun CTF Quals"/>
<meta name="twitter:description" content="Challenge Points: 223
Challenge Description:
Someone told me not to use DSA, so I came up with this.
In this challenge, we are given a script that signs any message given as an input:
class PrivateSigningKey: def __init__(self): self.gen = 0x44120dc98545c6d3d81bfc7898983e7b7f6ac8e08d3943af0be7f5d52264abb3775a905e003151ed0631376165b65c8ef72d0b6880da7e4b5e7b833377bb50fde65846426a5bfdc182673b6b2504ebfe0d6bca36338b3a3be334689c1afb17869baeb2b0380351b61555df31f0cda3445bba4023be72a494588d640a9da7bd16L self.q = 0x926c99d24bd4d5b47adb75bd9933de8be5932f4bL self.p = 0x80000000000001cda6f403d8a752a4e7976173ebfcd2acf69a29f4bada1ca3178b56131c2c1f00cf7875a2e7c497b10fea66b26436e40b7b73952081319e26603810a558f871d6d256fddbec5933b77fa7d1d0d75267dcae1f24ea7cc57b3a30f8ea09310772440f016c13e08b56b1196a687d6a5e5de864068f3fd936a361c5L self.key = int(FLAG.encode(&#34;hex&#34;), 16) def sign(self, m): def bytes_to_long(b): return long(b.encode(&#34;hex&#34;), 16) h = bytes_to_long(sha1(m).digest()) u = bytes_to_long(Random.new().read(20)) assert(bytes_to_long(m) % (self.q - 1) !"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Ctfs",
      "item": "https://ashutosh1206.github.io/ctf/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "EZDSA - Midnight Sun CTF Quals",
      "item": "https://ashutosh1206.github.io/ctf/midnightsunquals19-ezdsa/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "EZDSA - Midnight Sun CTF Quals",
  "name": "EZDSA - Midnight Sun CTF Quals",
  "description": "Challenge Points: 223\nChallenge Description:\nSomeone told me not to use DSA, so I came up with this.\nIn this challenge, we are given a script that signs any message given as an input:\nclass PrivateSigningKey: def __init__(self): self.gen = 0x44120dc98545c6d3d81bfc7898983e7b7f6ac8e08d3943af0be7f5d52264abb3775a905e003151ed0631376165b65c8ef72d0b6880da7e4b5e7b833377bb50fde65846426a5bfdc182673b6b2504ebfe0d6bca36338b3a3be334689c1afb17869baeb2b0380351b61555df31f0cda3445bba4023be72a494588d640a9da7bd16L self.q = 0x926c99d24bd4d5b47adb75bd9933de8be5932f4bL self.p = 0x80000000000001cda6f403d8a752a4e7976173ebfcd2acf69a29f4bada1ca3178b56131c2c1f00cf7875a2e7c497b10fea66b26436e40b7b73952081319e26603810a558f871d6d256fddbec5933b77fa7d1d0d75267dcae1f24ea7cc57b3a30f8ea09310772440f016c13e08b56b1196a687d6a5e5de864068f3fd936a361c5L self.key = int(FLAG.encode(\u0026#34;hex\u0026#34;), 16) def sign(self, m): def bytes_to_long(b): return long(b.encode(\u0026#34;hex\u0026#34;), 16) h = bytes_to_long(sha1(m).digest()) u = bytes_to_long(Random.new().read(20)) assert(bytes_to_long(m) % (self.q - 1) !",
  "keywords": [
    "NumberTheory"
  ],
  "articleBody": "Challenge Points: 223\nChallenge Description:\nSomeone told me not to use DSA, so I came up with this.\nIn this challenge, we are given a script that signs any message given as an input:\nclass PrivateSigningKey: def __init__(self): self.gen = 0x44120dc98545c6d3d81bfc7898983e7b7f6ac8e08d3943af0be7f5d52264abb3775a905e003151ed0631376165b65c8ef72d0b6880da7e4b5e7b833377bb50fde65846426a5bfdc182673b6b2504ebfe0d6bca36338b3a3be334689c1afb17869baeb2b0380351b61555df31f0cda3445bba4023be72a494588d640a9da7bd16L self.q = 0x926c99d24bd4d5b47adb75bd9933de8be5932f4bL self.p = 0x80000000000001cda6f403d8a752a4e7976173ebfcd2acf69a29f4bada1ca3178b56131c2c1f00cf7875a2e7c497b10fea66b26436e40b7b73952081319e26603810a558f871d6d256fddbec5933b77fa7d1d0d75267dcae1f24ea7cc57b3a30f8ea09310772440f016c13e08b56b1196a687d6a5e5de864068f3fd936a361c5L self.key = int(FLAG.encode(\"hex\"), 16) def sign(self, m): def bytes_to_long(b): return long(b.encode(\"hex\"), 16) h = bytes_to_long(sha1(m).digest()) u = bytes_to_long(Random.new().read(20)) assert(bytes_to_long(m) % (self.q - 1) != 0) k = pow(self.gen, u * bytes_to_long(m), self.q) r = pow(self.gen, k, self.p) % self.q s = pow(k, self.q - 2, self.q) * (h + self.key * r) % self.q assert(s != 0) return r, s We will use the notation below to represent the following variables:\n`m`: integer representation of message input given to the server for signing `h`: integer representation of SHA-1 of a message `m` `u`: integer representation of a 20 byte randomly generated string in every session `key`: integer representation of the flag `g`: base element of the group; alias `gen` The signature is similar to ElGamal signature, but works as follows:\n\\( k = g^{u;*;m};%;q \\)\n\\( r = (g^{k};%;p);%;q \\)\n\\( s = ((k^{q-2};%;q)*(h+(key*r)));%;q \\)\nServer returns (r, s) pair for any \\(m\\) given as input (with one exception that we will see later in the post)\nOur motive is to recover the value of key, since it is the integer representation of the flag!\nSetting a tentative target If by giving some input, k becomes equal to 1, then recovering key becomes very easy:\n\\(s = ((k^{(q-2)};%;q)*(h+(key*r)));%;q \\)\n\\(s = ((1^{(q-2)};%;q)*(h+(key*r)));%;q \\)\n\\(s = (h+(key*r));%;q\\)\n\\((s-h)*r^{-1}\\equiv key \\mod q \\)\nWe know the values of h, r and s, hence key can be calculated using the above formula, on one condition that k becomes equal to 1\nThe question now is: how do we make the value of k equal to 1?\nFinding input such that k=1 We now need to find an input message m such that \\(k = g^{u;*;m};%;q = 1\\)\nTrivial Approach The easiest approach is to send q-1 as m. This is because\n\\(k = g^{u;*;m};%;q\\)\n\\(k = g^{u;*;(q-1)};%;q\\)\n\\(k = (g^{(q-1)};%;q)^{u};%;q\\)\n\\(k = 1^u;%;q\\)\n\\(k = 1\\)\nThe above set of equations is a direct consequence of Fermat’s Little Theorem:\nif GCD(a, p) == 1 then:\n\\(a^{(p-1)}\\equiv 1 \\mod p\\)\nBut there is a problem. If we look at an assert statement in the function that signs our message:\nassert(bytes_to_long(m) % (self.q - 1) != 0) The above statement means that our message cannot be a multiple of q-1, hence we cannot send q-1 as m.\nApplying Euler’s Criterion Case-1: u is an even number In such a case, we can send m = (q-1)/2 and get the following:\n\\(k = g^{u;*;m};%;q \\)\n\\(k = g^{u’;*;2;*;m};%;q \\)\n\\(k = g^{u’;*;2;*;((q-1)/2)};%;q \\)\n\\(k = (g^{(q-1)};%;q)^{u’};%;q \\)\n\\(k = 1;%;q = 1 \\)\nCase-2: u is an odd number, we send m = (q-1)/2 and get the following:\n\\(k = g^{u;*;m};%;q\\)\n\\(k = g^{u;*;((q-1)/2)};%;q\\)\n\\(k = (g^{((q-1)/2)};%;q)^{u};%;q\\)\nFrom Euler’s Criterion, we have:\nIf GCD(a, p) == 1\n$$a^{(p-1)/2}\\equiv \\begin{cases} 1;(mod;p),\\exists x\\mid x^2\\equiv a\\mod p\\\\ -1;(mod;p), otherwise \\end{cases}$$\nThere are equal number of quadratic residues and quadratic non-residues in a group over a prime number. A proof of this is illustrated in Wikipedia: Source: Euler’s Criterion proof - Wikipedia\nThis basically means that no matter what, if m = (q-1)/2, value of k will be either 1 or -1. So, we sent m = (q-1)/2 to the server, and got r = g % q. This straightaway implies that k turned out to be equal to 1.\nkey can then be simply calculated as: $$ (s-h)*r^{-1}\\equiv key \\mod p $$\nfrom Crypto.Util.number import * h = 1317885328399162707374481214163502540222211181040L q = 0x926c99d24bd4d5b47adb75bd9933de8be5932f4bL # r, s values we got from the server after sending m = (q-1)/2 r = 698847418084580852997663919979623019513778951409L s = 629758878500372559472644038362239654961033814558L print long_to_bytes((s - h)*inverse(r, q) % q) Flag: th4t_w4s_e4sy_eh?\n",
  "wordCount" : "649",
  "inLanguage": "en",
  "datePublished": "2019-04-09T00:00:00Z",
  "dateModified": "2019-04-09T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Ashutosh Ahelleya"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://ashutosh1206.github.io/ctf/midnightsunquals19-ezdsa/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Ash's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://ashutosh1206.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://ashutosh1206.github.io/" accesskey="h" title="Home (Alt + H)">Home</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://ashutosh1206.github.io/blog/" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
            <li>
                <a href="https://ashutosh1206.github.io/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://ashutosh1206.github.io/archive/" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://ashutosh1206.github.io/ctf/" title="CTF">
                    <span>CTF</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      EZDSA - Midnight Sun CTF Quals
    </h1>
    <div class="post-meta"><span title='2019-04-09 00:00:00 +0000 UTC'>April 9, 2019</span>&nbsp;·&nbsp;Ashutosh Ahelleya

</div>
  </header> 
  <div class="post-content"><p><strong>Challenge Points</strong>: 223<br>
<strong>Challenge Description</strong>:</p>
<blockquote>
<p>Someone told me not to use DSA, so I came up with this.</p>
</blockquote>
<p>In this challenge, we are given a script that signs any message given as an input:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PrivateSigningKey</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>gen <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x44120dc98545c6d3d81bfc7898983e7b7f6ac8e08d3943af0be7f5d52264abb3775a905e003151ed0631376165b65c8ef72d0b6880da7e4b5e7b833377bb50fde65846426a5bfdc182673b6b2504ebfe0d6bca36338b3a3be334689c1afb17869baeb2b0380351b61555df31f0cda3445bba4023be72a494588d640a9da7bd16</span>L
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>q <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x926c99d24bd4d5b47adb75bd9933de8be5932f4b</span>L
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>p <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x80000000000001cda6f403d8a752a4e7976173ebfcd2acf69a29f4bada1ca3178b56131c2c1f00cf7875a2e7c497b10fea66b26436e40b7b73952081319e26603810a558f871d6d256fddbec5933b77fa7d1d0d75267dcae1f24ea7cc57b3a30f8ea09310772440f016c13e08b56b1196a687d6a5e5de864068f3fd936a361c5</span>L
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>key <span style="color:#f92672">=</span> int(FLAG<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#34;hex&#34;</span>), <span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">sign</span>(self, m):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">bytes_to_long</span>(b):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> long(b<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#34;hex&#34;</span>), <span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">=</span> bytes_to_long(sha1(m)<span style="color:#f92672">.</span>digest())
</span></span><span style="display:flex;"><span>        u <span style="color:#f92672">=</span> bytes_to_long(Random<span style="color:#f92672">.</span>new()<span style="color:#f92672">.</span>read(<span style="color:#ae81ff">20</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span>(bytes_to_long(m) <span style="color:#f92672">%</span> (self<span style="color:#f92672">.</span>q <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        k <span style="color:#f92672">=</span> pow(self<span style="color:#f92672">.</span>gen, u <span style="color:#f92672">*</span> bytes_to_long(m), self<span style="color:#f92672">.</span>q)
</span></span><span style="display:flex;"><span>        r <span style="color:#f92672">=</span> pow(self<span style="color:#f92672">.</span>gen, k, self<span style="color:#f92672">.</span>p) <span style="color:#f92672">%</span> self<span style="color:#f92672">.</span>q
</span></span><span style="display:flex;"><span>        s <span style="color:#f92672">=</span> pow(k, self<span style="color:#f92672">.</span>q <span style="color:#f92672">-</span> <span style="color:#ae81ff">2</span>, self<span style="color:#f92672">.</span>q) <span style="color:#f92672">*</span> (h <span style="color:#f92672">+</span> self<span style="color:#f92672">.</span>key <span style="color:#f92672">*</span> r) <span style="color:#f92672">%</span> self<span style="color:#f92672">.</span>q
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span>(s <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> r, s
</span></span></code></pre></div><p>We will use the notation below to represent the following variables:</p>
<pre tabindex="0"><code>`m`: integer representation of message input given to the server for signing  
`h`: integer representation of SHA-1 of a message `m`  
`u`: integer representation of a 20 byte randomly generated string in every session  
`key`: integer representation of the flag   
`g`: base element of the group; alias `gen`
</code></pre><p>The signature is similar to ElGamal signature, but works as follows:<br>
\( k = g^{u;*;m};%;q \)</p>
<p>\( r = (g^{k};%;p);%;q \)</p>
<p>\( s = ((k^{q-2};%;q)*(h+(key*r)));%;q \)</p>
<p>Server returns <code>(r, s)</code> pair for any \(m\) given as input (with one exception that we will see later in the post)</p>
<p>Our <strong>motive</strong> is to recover the value of <code>key</code>, since it is the integer representation of the flag!</p>
<h2 id="setting-a-tentative-target">Setting a tentative target<a hidden class="anchor" aria-hidden="true" href="#setting-a-tentative-target">#</a></h2>
<p>If by giving some input, <code>k</code> becomes equal to 1, then recovering <code>key</code> becomes very easy:<br>
\(s = ((k^{(q-2)};%;q)*(h+(key*r)));%;q \)<br>
\(s = ((1^{(q-2)};%;q)*(h+(key*r)));%;q \)<br>
\(s = (h+(key*r));%;q\)<br>
\((s-h)*r^{-1}\equiv key \mod q \)</p>
<p>We know the values of <code>h</code>, <code>r</code> and <code>s</code>, hence <code>key</code> can be calculated using the above formula,
on one <strong>condition</strong> that <code>k</code> becomes equal to 1</p>
<p>The question now is: <strong>how</strong> do we make the value of <code>k</code> equal to 1?</p>
<h2 id="finding-input-such-that-k1">Finding input such that k=1<a hidden class="anchor" aria-hidden="true" href="#finding-input-such-that-k1">#</a></h2>
<p>We now need to find an input message <code>m</code> such that
\(k = g^{u;*;m};%;q = 1\)</p>
<h3 id="trivial-approach">Trivial Approach<a hidden class="anchor" aria-hidden="true" href="#trivial-approach">#</a></h3>
<p>The easiest approach is to send <code>q-1</code> as <code>m</code>. This is because<br>
\(k = g^{u;*;m};%;q\)<br>
\(k = g^{u;*;(q-1)};%;q\)<br>
\(k = (g^{(q-1)};%;q)^{u};%;q\)<br>
\(k = 1^u;%;q\)<br>
\(k = 1\)</p>
<p>The above set of equations is a direct consequence of Fermat&rsquo;s Little Theorem:</p>
<blockquote>
<p>if GCD(a, p) == 1 then:<br>
\(a^{(p-1)}\equiv 1 \mod p\)</p>
</blockquote>
<p>But there is a <strong>problem</strong>. If we look at an assert statement in the function that signs our message:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">assert</span>(bytes_to_long(m) <span style="color:#f92672">%</span> (self<span style="color:#f92672">.</span>q <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>)
</span></span></code></pre></div><p>The above statement means that our message cannot be a multiple of q-1, hence we cannot send <code>q-1</code> as <code>m</code>.</p>
<h3 id="applying-eulers-criterion">Applying Euler&rsquo;s Criterion<a hidden class="anchor" aria-hidden="true" href="#applying-eulers-criterion">#</a></h3>
<p><strong>Case-1</strong>: <code>u</code> is an even number
In such a case, we can send <code>m = (q-1)/2</code> and get the following:<br>
\(k = g^{u;*;m};%;q \)<br>
\(k = g^{u&rsquo;;*;2;*;m};%;q \)<br>
\(k = g^{u&rsquo;;*;2;*;((q-1)/2)};%;q \)<br>
\(k = (g^{(q-1)};%;q)^{u&rsquo;};%;q \)<br>
\(k = 1;%;q = 1 \)</p>
<p><strong>Case-2</strong>: <code>u</code> is an odd number, we send <code>m = (q-1)/2</code> and get the following:<br>
\(k = g^{u;*;m};%;q\)<br>
\(k = g^{u;*;((q-1)/2)};%;q\)<br>
\(k = (g^{((q-1)/2)};%;q)^{u};%;q\)</p>
<p>From <a href="https://en.wikipedia.org/wiki/Euler%27s_criterion">Euler&rsquo;s Criterion</a>, we have:</p>
<blockquote>
<p>If GCD(a, p) == 1<br>
$$a^{(p-1)/2}\equiv \begin{cases} 1;(mod;p),\exists x\mid x^2\equiv a\mod p\\ -1;(mod;p), otherwise \end{cases}$$</p>
</blockquote>
<p>There are equal number of quadratic residues and quadratic non-residues in a group over a prime number. A proof of this is illustrated in Wikipedia:
<img loading="lazy" src="/midnightsunquals19-ezdsa-1.png" alt="picture"  />

<strong>Source</strong>: <em><a href="https://en.wikipedia.org/wiki/Euler%27s_criterion">Euler&rsquo;s Criterion proof - Wikipedia</a></em></p>
<p>This basically means that no matter what, if <code>m = (q-1)/2</code>, value of <code>k</code> will be either <code>1</code> or <code>-1</code>. So, we sent <code>m = (q-1)/2</code> to the server, and got <code>r = g % q</code>. This straightaway implies that <code>k</code> turned out to be equal to 1.</p>
<p><code>key</code> can then be simply calculated as:
$$ (s-h)*r^{-1}\equiv key \mod p $$</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> Crypto.Util.number <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>h <span style="color:#f92672">=</span> <span style="color:#ae81ff">1317885328399162707374481214163502540222211181040</span>L
</span></span><span style="display:flex;"><span>q <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x926c99d24bd4d5b47adb75bd9933de8be5932f4b</span>L
</span></span><span style="display:flex;"><span><span style="color:#75715e"># r, s values we got from the server after sending m = (q-1)/2</span>
</span></span><span style="display:flex;"><span>r <span style="color:#f92672">=</span> <span style="color:#ae81ff">698847418084580852997663919979623019513778951409</span>L
</span></span><span style="display:flex;"><span>s <span style="color:#f92672">=</span> <span style="color:#ae81ff">629758878500372559472644038362239654961033814558</span>L
</span></span><span style="display:flex;"><span>print long_to_bytes((s <span style="color:#f92672">-</span> h)<span style="color:#f92672">*</span>inverse(r, q) <span style="color:#f92672">%</span> q)
</span></span></code></pre></div><p>Flag: <strong>th4t_w4s_e4sy_eh?</strong></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://ashutosh1206.github.io/tags/numbertheory/">NumberTheory</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://ashutosh1206.github.io/">Ash&#39;s blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
